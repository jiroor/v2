# test-quality.md - テスト品質保護ルール

このルールは、テストの改ざんや品質低下を防ぐために設定されています。

---

## 🚨 絶対禁止事項

### 1. テストの削除・無効化

**禁止される行為**:
- テストファイルの削除
- テストケースのコメントアウト
- `skip()`, `xit()`, `test.skip()` などによるテストの無効化
- テストの実行条件を変更してテストをスキップ

**理由**:
- テストは品質保証の要
- 既存のテストが通らないのは、コードに問題がある証拠
- テストを削除するのは、問題を隠蔽する行為

**正しい対応**:
- テストが失敗する原因を調査
- コードを修正してテストを通す
- テストが不適切なら、テスト自体を改善

---

### 2. テストの緩和

**禁止される行為**:
- アサーションを弱くする（例: `toBe()` → `toBeTruthy()`）
- アサーションの削除
- エラーケースのテストを削除
- タイムアウト時間を無限に延長

**理由**:
- テストが緩いと、バグを見逃す
- 品質が低下する

**正しい対応**:
- テストが厳しすぎる場合は、テスト設計を見直す
- 適切なアサーションを使用

---

### 3. モックの乱用

**禁止される行為**:
- 実装の詳細をすべてモック化
- テストが何も検証していない状態にする
- モックを使ってテストを必ず通るようにする

**理由**:
- モックの乱用は、テストの意味を失わせる
- 実際の動作を検証できない

**正しい対応**:
- 必要最小限のモック化
- 外部依存（API、DB）のみモック
- ビジネスロジックは実際のコードで検証

---

## ✅ テスト追加のガイドライン

### 新機能を追加する際のテスト

**必須**:
- 正常系のテスト
- 異常系のテスト（エラーハンドリング）
- エッジケースのテスト

**推奨**:
- ユニットテスト（関数、フック）
- コンポーネントテスト（UI の動作）
- 統合テスト（複数のコンポーネントの連携）

---

### テストが存在しない場合

**現状**:
このプロジェクトは、まだテストが実装されていません。

**将来の方針**:
- 主要コンポーネントにユニットテストを追加
- E2E テストの導入を検討
- CI/CD パイプラインでテストを自動実行

**テスト追加時の原則**:
- テストファーストではなく、既存コードにテストを追加
- カバレッジ 100% を目指さない（重要な部分を優先）
- テストの保守性を重視

---

## 🛡️ テストの保護

### テストが失敗した場合の対応フロー

1. **原因の調査**
   - エラーメッセージを確認
   - どのテストが失敗しているか特定
   - 最近の変更を確認

2. **修正**
   - コードを修正してテストを通す
   - テストが不適切なら、テストを修正
   - **絶対にテストを削除・無効化しない**

3. **確認**
   - すべてのテストが通ることを確認
   - リグレッションがないか確認

4. **コミット**
   - 修正内容をコミット
   - コミットメッセージに修正内容を記載

---

## 📝 例外ケース

### テストを削除・変更できる場合

**許可される場合**:
1. **要件変更**: 機能仕様が変更され、テストが不要になった
2. **リファクタリング**: テスト対象のコードが削除された
3. **テスト設計の改善**: より良いテストに置き換える

**必須条件**:
- 変更理由を明確に記録
- レビューで承認を得る
- 代替テストを追加（削除の場合）

**記録方法**:
```markdown
# memories/deleted/YYYYMMDD-test-name.md

## 削除したテスト
[テスト名]

## 削除理由
[なぜ削除したか]

## 影響範囲
[どの機能に影響があるか]

## 代替手段
[代わりにどうカバーするか]
```

---

## 🎯 テスト品質の目標

### 将来的な目標

- **カバレッジ**: 主要機能の 80% 以上
- **テスト速度**: すべてのテストが 1 分以内に完了
- **信頼性**: テストが不安定（flaky）でない
- **保守性**: テストが読みやすく、理解しやすい

---

## 💡 まとめ

**テストは品質保証の要です。テストを削除・無効化することは、品質低下につながります。**

**困ったら**:
- テストが失敗する原因を調査
- コードを修正してテストを通す
- テストを削除・無効化しない

**どうしてもテストを変更する必要がある場合**:
- 変更理由を明確に記録
- `memories/deleted/` に記録を残す

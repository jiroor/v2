# ローカルカメラ映像共有機能

## 日付
2025-11-02

## 実装目的

ローカルエリアネットワーク（LAN/WiFi）内で、複数のiPhone端末間でカメラ映像をリアルタイムに共有できる機能を実装する。主な用途は監視カメラ・見守り機能。

## ユーザー要件

- **主な用途**: 監視カメラ・見守り（赤ちゃん、ペット、防犯など）
- **カメラ台数**: 無制限（ネットワーク帯域が許す限り）
- **品質要件**: 低遅延優先（0.5秒以内のリアルタイム性）
- **録画機能**: 不要（リアルタイム視聴のみ）
- **対応デバイス**: iPhone（将来的にAndroid、PCも想定）

## 技術要件

### 制約事項

1. **完全クライアントサイド**
   - バックエンドサーバー不要（プロジェクトのコンセプト）
   - Vercel等の静的ホスティングで動作

2. **ローカルネットワーク限定**
   - 同一LAN/WiFi内での通信
   - インターネット経由の接続は対象外

3. **軽量性**
   - バンドルサイズを最小限に抑える
   - 現在のプロジェクト: 73KB（gzip）→ 目標: 100KB未満を維持

### 技術的課題

#### 課題1: P2P通信の実装

**問題点**:
- WebRTCのシグナリングサーバーが通常必要
- バックエンド不要という制約との矛盾

**解決策の候補**:

1. **WebRTC + ローカルシグナリング**
   - PeerJS + 手動でシグナリング情報をコピペ
   - または QRコード経由でOffer/Answerを交換
   - メリット: 低遅延、高品質
   - デメリット: 接続手順が煩雑

2. **WebSocket + ローカルサーバー（不採用）**
   - ユーザーが別途サーバーを立てる必要がある
   - プロジェクトのコンセプトに反する

3. **WebRTC Data Channel + mDNS/Bonjour**
   - ローカルネットワーク内での自動検出
   - ブラウザからのmDNS利用は制限がある
   - 実装困難

4. **シンプルなアプローチ: 手動接続**
   - カメラ側がルームID（ランダム文字列）を生成
   - ビューワー側がルームIDを入力して接続
   - WebRTC + Firebaseシグナリング（無料枠）
   - または PeerJS公開サーバーを利用

**推奨アプローチ**: **WebRTC + PeerJS（公開サーバー利用）**

理由:
- PeerJSは無料の公開シグナリングサーバーを提供
- 接続後はP2P通信のためサーバー負荷なし
- 実装がシンプル
- バンドルサイズ: 約15KB（許容範囲）

#### 課題2: 複数カメラの管理

**アーキテクチャ案**:

```
[カメラ端末A] ─┐
[カメラ端末B] ─┼─→ [ビューワー端末]
[カメラ端末C] ─┘
```

- 1つのビューワーが複数のカメラに同時接続
- 各カメラは独立したPeerID（ルームID）を持つ
- ビューワーは複数のルームIDを管理

## 機能設計

### 画面構成

#### 1. モード選択画面（ホーム）

```
┌─────────────────────┐
│   カメラ映像共有     │
├─────────────────────┤
│                     │
│  ┌───────────────┐  │
│  │  カメラになる  │  │
│  │  📷 Camera    │  │
│  └───────────────┘  │
│                     │
│  ┌───────────────┐  │
│  │ 映像を見る     │  │
│  │  👁 Viewer     │  │
│  └───────────────┘  │
│                     │
└─────────────────────┘
```

#### 2. カメラ画面

```
┌─────────────────────┐
│  カメラモード        │
├─────────────────────┤
│                     │
│  ┌─────────────┐    │
│  │ カメラ映像  │    │
│  │ [プレビュー] │    │
│  └─────────────┘    │
│                     │
│  ルームID:          │
│  ┌─────────────┐    │
│  │ ABC-DEF-GHI │    │
│  │  [コピー] 📋 │    │
│  └─────────────┘    │
│                     │
│  QRコード:          │
│  ┌─────────┐        │
│  │ [■■■■] │        │
│  └─────────┘        │
│                     │
│  接続中: 2台        │
│                     │
│  [配信停止]         │
│                     │
└─────────────────────┘
```

#### 3. ビューワー画面

```
┌─────────────────────┐
│  ビューワーモード    │
├─────────────────────┤
│                     │
│  カメラを追加:       │
│  ┌─────────────┐    │
│  │ ルームID入力 │    │
│  │ [追加] [QR]  │    │
│  └─────────────┘    │
│                     │
│  カメラ一覧:        │
│  ┌─────────────┐    │
│  │ カメラ1      │    │
│  │ [■映像■]    │    │
│  │ 遅延: 0.3s   │    │
│  │ [削除]       │    │
│  └─────────────┘    │
│  ┌─────────────┐    │
│  │ カメラ2      │    │
│  │ [■映像■]    │    │
│  │ 遅延: 0.5s   │    │
│  │ [削除]       │    │
│  └─────────────┘    │
│                     │
│  [全画面表示]       │
│                     │
└─────────────────────┘
```

#### 4. 全画面ビュー（複数カメラ）

```
┌────────────────────────────┐
│  ┌──────────┐  ┌──────────┐ │
│  │ カメラ1  │  │ カメラ2  │ │
│  │ [■■■■] │  │ [■■■■] │ │
│  └──────────┘  └──────────┘ │
│  ┌──────────┐  ┌──────────┐ │
│  │ カメラ3  │  │ カメラ4  │ │
│  │ [■■■■] │  │ [■■■■] │ │
│  └──────────┘  └──────────┘ │
│                            │
│  [タップでフォーカス表示]   │
└────────────────────────────┘
```

### データ構造

#### カメラ情報

```typescript
interface CameraStream {
  id: string              // PeerID（ルームID）
  name: string            // カメラ名（ユーザー設定可能）
  peerId: string          // PeerJS ID
  connection: MediaConnection | null
  stream: MediaStream | null
  status: 'connecting' | 'connected' | 'disconnected'
  latency: number         // 遅延時間（ms）
  createdAt: Date
}

interface CameraConfig {
  id: string
  name: string
  resolution: '360p' | '480p' | '720p'  // 画質設定
  facingMode: 'user' | 'environment'    // フロント/バックカメラ
}
```

#### LocalStorage保存データ

```typescript
interface SavedCameras {
  cameras: Array<{
    id: string
    name: string
    lastConnected: string  // ISO 8601
  }>
}
```

### API設計（内部関数）

#### カメラ側

```typescript
// カメラストリームを開始
async function startCamera(config: CameraConfig): Promise<void>

// ルームIDを生成
function generateRoomId(): string

// QRコードを生成
function generateQRCode(roomId: string): string

// 接続中のビューワー数を取得
function getViewerCount(): number

// 配信を停止
function stopCamera(): void
```

#### ビューワー側

```typescript
// ルームIDでカメラに接続
async function connectToCamera(roomId: string): Promise<CameraStream>

// QRコードからカメラに接続
async function connectByCameraQRCode(qrData: string): Promise<CameraStream>

// カメラとの接続を切断
function disconnectCamera(cameraId: string): void

// 全カメラ切断
function disconnectAll(): void

// 遅延を測定
function measureLatency(cameraId: string): number
```

#### 共通

```typescript
// PeerJSの初期化
async function initializePeer(): Promise<Peer>

// カメラ一覧をLocalStorageに保存
function saveCameraList(cameras: SavedCameras): void

// カメラ一覧をLocalStorageから読み込み
function loadCameraList(): SavedCameras
```

## 技術スタック

### 新規追加が必要なライブラリ

```json
{
  "dependencies": {
    "peerjs": "^1.5.4",           // WebRTC P2P通信（~15KB）
    "qrcode": "^1.5.4"             // QRコード生成（既存）
  }
}
```

### 使用するブラウザAPI

1. **MediaDevices API**
   - `navigator.mediaDevices.getUserMedia()` - カメラアクセス
   - `navigator.mediaDevices.enumerateDevices()` - カメラ一覧取得

2. **WebRTC API**
   - `RTCPeerConnection` - P2P接続（PeerJSがラップ）
   - `MediaStream` - 映像ストリーム

3. **その他**
   - LocalStorage - カメラ一覧保存
   - QR Code Scanner（html5-qrcode等）- QRコード読み取り

## 実装計画

### Phase 1: 基本機能（MVP）

優先度: 高

- [ ] PeerJSのセットアップ
- [ ] モード選択画面の実装
- [ ] カメラ画面の実装
  - [ ] カメラストリーム取得
  - [ ] ルームID生成と表示
  - [ ] QRコード生成
- [ ] ビューワー画面の実装
  - [ ] ルームID入力で接続
  - [ ] 映像表示
  - [ ] 遅延表示
- [ ] 基本的なエラーハンドリング

**完了条件**:
- 1台のカメラと1台のビューワーで映像共有が動作
- 遅延が1秒以内

### Phase 2: 複数カメラ対応

優先度: 高

- [ ] 複数カメラへの同時接続
- [ ] カメラ一覧表示
- [ ] カメラの追加/削除
- [ ] LocalStorageでカメラ一覧保存
- [ ] グリッド表示（2x2、3x3など）

### Phase 3: UX改善

優先度: 中

- [ ] QRコードスキャン機能
- [ ] カメラ名の編集
- [ ] 画質設定（360p/480p/720p）
- [ ] フロント/バックカメラ切り替え
- [ ] 全画面表示
- [ ] フォーカス表示（1カメラを大きく表示）
- [ ] 接続状態のビジュアル表示
- [ ] 音声ON/OFF切り替え

### Phase 4: 最適化

優先度: 中

- [ ] 自動再接続機能
- [ ] 帯域幅に応じた画質自動調整
- [ ] 接続品質モニタリング
- [ ] バッテリー消費の最適化

### Phase 5: 追加機能（将来）

優先度: 低

- [ ] スナップショット（静止画キャプチャ）
- [ ] 簡易録画機能（ブラウザ内保存）
- [ ] 動作検知アラート
- [ ] パスワード保護
- [ ] Android/PC対応の動作確認

## セキュリティ・プライバシー

### セキュリティ対策

1. **ルームIDの推測困難性**
   - 12文字以上のランダム文字列
   - 例: `xK9-mP2-qL5-wR8`

2. **接続の制限**
   - ローカルネットワーク内のみ（技術的制約）
   - 明示的な接続のみ（自動検出なし）

3. **データ保護**
   - WebRTCは暗号化（DTLS）
   - LocalStorageにはルームIDのみ保存（映像は保存しない）

### プライバシー配慮

1. **カメラ権限の明示的な許可**
   - ブラウザのカメラ許可ダイアログ
   - 使用目的の明確な説明

2. **配信中の視覚的インジケーター**
   - 「配信中」のバッジ表示
   - 接続数の表示

3. **簡単な停止**
   - ワンタップで配信停止
   - ページを閉じれば自動停止

## パフォーマンス要件

### 目標

- **遅延**: 0.5秒以内（カメラ→ビューワー）
- **フレームレート**: 15-30 FPS
- **解像度**: 480p（デフォルト）、360p/720p選択可能
- **バンドルサイズ**: +15KB（PeerJS追加後も100KB未満）

### 最適化戦略

1. **画質の動的調整**
   - ネットワーク状況に応じて自動調整
   - デフォルトは480p（バランス型）

2. **接続数の制限**
   - 実用上は4-6カメラまでを推奨
   - それ以上は警告表示

3. **バッテリー消費の警告**
   - 長時間配信時の警告メッセージ

## リスク・課題

### 技術的リスク

1. **ブラウザ互換性**
   - Safari（iOS）のWebRTC対応状況
   - 対策: Safari対応を優先的にテスト

2. **ネットワーク不安定性**
   - WiFiが不安定な場合の対応
   - 対策: 自動再接続、接続品質の表示

3. **バッテリー消費**
   - カメラ配信は消費電力が大きい
   - 対策: 警告表示、省電力モードの検討

4. **PeerJS公開サーバーの可用性**
   - 無料サーバーのダウン時
   - 対策: 代替サーバーの設定機能

### UXリスク

1. **接続手順の煩雑さ**
   - ルームIDのコピペが面倒
   - 対策: QRコード連携、最近使ったカメラの保存

2. **遅延の体感**
   - 0.5秒でも遅延を感じる可能性
   - 対策: 遅延時間の表示で期待値調整

## 代替案の検討

### 案1: WebRTC + 手動Offer/Answer交換

**メリット**:
- 外部サーバー不要

**デメリット**:
- 接続手順が極めて煩雑（JSON文字列をコピペ）
- ユーザビリティが低い

**結論**: 不採用

### 案2: WebSocket + 別途サーバー

**メリット**:
- 低遅延、安定性

**デメリット**:
- ユーザーがサーバーを立てる必要
- プロジェクトのコンセプトに反する

**結論**: 不採用

### 案3: Firebaseシグナリング

**メリット**:
- 無料枠が大きい
- 信頼性が高い

**デメリット**:
- Firebase SDKのバンドルサイズが大きい（~50KB）
- PeerJSより実装が複雑

**結論**: バンドルサイズの観点から不採用、PeerJSを優先

## 実装ファイル構成

```
src/
├── pages/
│   └── Camera/
│       ├── CameraSharing.tsx      # モード選択画面
│       ├── CameraMode.tsx         # カメラ画面
│       ├── ViewerMode.tsx         # ビューワー画面
│       └── FullscreenView.tsx     # 全画面表示
├── hooks/
│   ├── usePeer.ts                 # PeerJS管理
│   ├── useCamera.ts               # カメラストリーム管理
│   ├── useViewer.ts               # ビューワー管理
│   └── useCameraStorage.ts        # LocalStorage管理
├── utils/
│   ├── peerUtils.ts               # PeerJS関連ユーティリティ
│   ├── cameraUtils.ts             # カメラ関連ユーティリティ
│   └── roomIdUtils.ts             # ルームID生成・検証
├── types/
│   └── camera.ts                  # カメラ関連の型定義
└── constants/
    └── camera.ts                  # カメラ設定の定数
```

## デプロイ・テスト

### テスト環境

1. **デバイス**
   - iPhone（Safari）x 複数台
   - 同一WiFiネットワーク

2. **テストケース**
   - 1カメラ - 1ビューワー
   - 1カメラ - 複数ビューワー
   - 複数カメラ - 1ビューワー
   - ネットワーク切断/再接続

### デプロイ手順

1. PeerJSをインストール
2. 機能実装
3. ビルドサイズ確認（100KB未満）
4. Vercelにデプロイ
5. 実機テスト

## 完了条件

### Phase 1（MVP）

- [x] 要件定義完了
- [ ] 1対1でカメラ映像共有が動作
- [ ] 遅延が1秒以内
- [ ] QRコード連携が動作
- [ ] エラーハンドリング実装

### Phase 2（複数カメラ）

- [ ] 複数カメラの同時接続
- [ ] カメラ一覧管理
- [ ] グリッド表示

### Phase 3（UX改善）

- [ ] 全機能実装
- [ ] バンドルサイズ100KB未満
- [ ] 実機テスト完了

## 参考資料

- [PeerJS Documentation](https://peerjs.com/docs/)
- [WebRTC API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API)
- [MediaDevices.getUserMedia() - MDN](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)
